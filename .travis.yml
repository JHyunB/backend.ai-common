language: python

cache: pip

sudo: required

services:
  - docker
  - rabbitmq

python:
  - "3.6"

install:
  - pip install -U pip
  - pip install -U wheel setuptools
  - pip install -U -r requirements-dev.txt

env:
  global:
    - SORNA_ETCD_ADDR=localhost:2379
    - SORNA_MQ_ADDR=localhost:5672
    - SORNA_MQ_LOGIN=guest
    - SORNA_MQ_PASS=guest
    - SORNA_NAMESPACE=local

before_script:
  - mkdir -p /tmp/etcd
  - rabbitmqctl add_vhost "$SORNA_NAMESPACE"
  - rabbitmqctl set_permissions -p "$SORNA_NAMESPACE" "$SORNA_MQ_LOGIN" '.*' '.*' '.*'
  - docker run -d -p 2379:2379 -p 2380:2380
     -v /tmp/etcd:/etcd-data
     --name sorna-etcd
     quay.io/coreos/etcd:v3.1.8
     /usr/local/bin/etcd
     -name sorna-etcd
     -data-dir /etcd-data
     -listen-client-urls http://0.0.0.0:2379
     -advertise-client-urls http://0.0.0.0:2379
     -listen-peer-urls http://0.0.0.0:2380
     -initial-advertise-peer-urls http://0.0.0.0:2380
     -initial-cluster sorna-etcd=http://0.0.0.0:2380
     -initial-cluster-token sorna-etcd-token
     -initial-cluster-state new
     -auto-compaction-retention 1

script:
  - sudo cat /var/lib/rabbitmq/.erlang.cookie
  - python -m pytest -m "not integration" --cov=sorna

after_success:
  - codecov

notifications:
  webhooks:
    secure: cxoCAPmP8hSRONXEOCnFY8AaENFmb6fMf8NeNuTFF3bM/B423YL1zHhGdrFxD3wgRWvrWJ/V83XksbmvTZ2BEy8xpVBNFi7F4bXZoMcl9mbUingSB6QInOnUf3LGLpBn9Hm8DKhLZ8O26x/nFLPdqOR8qyW3D7UAbJABUMXt1H2WuBRAUmRB5i8mkdv6QyKnc0wFp2G09pmDpAnIWTz5rdhZJevyXgVGihlYbQ9zxdKAIrk8erdZM8uBnVA7IGDpwc6zDSELQboHv/MqPOzwMWh49O6jIFllBD8zBbZnQN+qE7Tmad1iEUht71d+WKEUQlP6zuy1hXgZ9ZbPiV0brO2pPCmj+0rBKT1YPhWrpow/iPJIma9lOdl3yei/qHgQRHtjqET6fLAGlqJ8PJrhWsXn3+pTUaIl828pcKjPjqqNZKktmRma5jnpUHA2wOxE6cnfPuXoMdrmIfrE7H2knCU+THo4yiqVz6dPme1p+XvDuUQqdWamSFEV0/jXbo2ZYxqWwj2imQHH5d/1jRTYkVEdQ5NMDUZRnvBxl1YJnAaQ2UImfRZAQ2hXAbXHRpWAzYYBC0WlQzXBP6Z/VQbCKwl6TAvncpAE5JFgjxlxQ5QKSyivBiZVtVfX4jKTp405W3EiedvRY29DGxExpBs4EM76vJyu+ExZiRNUXqLYLfo=
